{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Notification Management</h1>
</div>

<div class="row">
    {# ** FIX: Only show this creation form to admins ** #}
    {% if session.role == 'admin' %}
    <div class="col-md-5">
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5 class="card-title"><i class="fas fa-plus-circle me-2"></i>Create New Notification</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('notifications.add_notification') }}" method="POST">
                    <div class="mb-3">
                        <label for="message" class="form-label">Notification Message</label>
                        <textarea class="form-control" id="message" name="message" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="target_audience" class="form-label">Target Audience</label>
                        <select class="form-select" id="target_audience" name="target_audience">
                            <option value="staff" selected>Staff (for Bell Icon)</option>
                            <option value="visitor">Visitors (for Public Headline)</option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Create Notification</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {# This column will be full width for jailers, and smaller for admins #}
    <div class="{% if session.role == 'admin' %}col-md-7{% else %}col-md-12{% endif %}">
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5 class="card-title"><i class="fas fa-history me-2"></i>Notification History</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for notification in notifications %}
                <div class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1">{{ notification.message }}</p>
                        <small class="text-muted">
                            Target: 
                            <span class="badge bg-secondary">{{ notification.target_audience }}</span>
                            - {{ notification.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </small>
                    </div>
                    {# Only show the delete button to admins #}
                    {% if session.role == 'admin' %}
                    <button class="btn btn-sm btn-outline-danger delete-notification-btn" data-id="{{ notification.id }}">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                </div>
                {% else %}
                <div class="list-group-item list-group-item-dark text-center text-muted">No notifications found.</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to permanently delete this notification?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    let notificationIdToDelete = null;

    // Handle showing the Delete Confirmation Modal
    document.querySelectorAll('.delete-notification-btn').forEach(button => {
        button.addEventListener('click', () => {
            notificationIdToDelete = button.dataset.id;
            deleteModal.show();
        });
    });

    // Handle the actual deletion
    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
        if (!notificationIdToDelete) return;
        
        fetch(`/delete_notification/${notificationIdToDelete}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    deleteModal.hide();
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.error || 'Failed to delete notification.', 'danger');
                }
            });
    });
});
</script>
{% endblock %}
