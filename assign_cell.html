{% extends "base.html" %}

{% block extra_css %}
<style>
    .assignment-board {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        height: 65vh;
    }
    .assignment-column {
        background-color: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }
    .column-header {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--bs-border-color);
    }
    .item-list {
        overflow-y: auto;
        flex-grow: 1;
    }
    .item-card {
        background-color: #161b22;
        border: 2px solid #30363d;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .item-card:hover {
        background-color: #30363d;
        border-color: #58a6ff;
    }
    .item-card.selected {
        border-color: #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        transform: scale(1.02);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Assign Inmate to Cell</h1>
</div>

<div class="assignment-board">
    <!-- Inmates Column -->
    <div class="assignment-column">
        <div class="column-header text-center">
            <h4 class="mb-0"><i class="fas fa-user-lock me-2"></i>Unassigned Inmates</h4>
        </div>
        <div class="item-list">
            {% for inmate in unassigned_inmates %}
                <div class="card item-card mb-2" data-type="inmate" data-id="{{ inmate.id }}">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-0">{{ inmate.name }}</h6>
                    </div>
                </div>
            {% else %}
                <p class="text-center text-muted mt-3">No unassigned inmates available.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Cells Column -->
    <div class="assignment-column">
        <div class="column-header text-center">
            <h4 class="mb-0"><i class="fas fa-th-large me-2"></i>Available Cells</h4>
        </div>
        <div class="item-list">
            {% for cell in available_cells %}
                <div class="card item-card mb-2" data-type="cell" data-id="{{ cell.id }}">
                    <div class="card-body p-3 d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">Cell {{ cell.cell_number }}</h6>
                        <span class="badge bg-secondary">{{ cell.current_occupants }} / {{ cell.capacity }} Occupied</span>
                    </div>
                </div>
            {% else %}
                <p class="text-center text-muted mt-3">No available cells.</p>
            {% endfor %}
        </div>
    </div>
</div>

<div class="mt-4 text-center">
    <form id="assignCellForm" class="d-inline-block">
        <input type="hidden" name="inmate_id" id="selected_inmate_id">
        <input type="hidden" name="cell_id" id="selected_cell_id">
        <button type="submit" id="assignBtn" class="btn btn-primary btn-lg" disabled>
            Assign Selected Inmate to Selected Cell
        </button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedInmateId = null;
    let selectedCellId = null;

    const assignBtn = document.getElementById('assignBtn');
    const inmateCards = document.querySelectorAll('.item-card[data-type="inmate"]');
    const cellCards = document.querySelectorAll('.item-card[data-type="cell"]');

    function checkSelections() {
        if (selectedInmateId && selectedCellId) {
            assignBtn.disabled = false;
        } else {
            assignBtn.disabled = true;
        }
    }

    inmateCards.forEach(card => {
        card.addEventListener('click', () => {
            inmateCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedInmateId = card.dataset.id;
            document.getElementById('selected_inmate_id').value = selectedInmateId;
            checkSelections();
        });
    });

    cellCards.forEach(card => {
        card.addEventListener('click', () => {
            cellCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedCellId = card.dataset.id;
            document.getElementById('selected_cell_id').value = selectedCellId;
            checkSelections();
        });
    });

    document.getElementById('assignCellForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        fetch('/assign_cell', { method: 'POST', body: new FormData(this) })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.error || 'Failed to assign inmate.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An unexpected error occurred.', 'danger');
            });
    });
});
</script>
{% endblock %}
